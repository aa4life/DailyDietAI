/* eslint-disable no-console */
const { createApp, ref, reactive, onMounted } = Vue;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1. Âª∫Á´ã Vue App
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const app = createApp({
  setup () {
    /* -------------------------------------------------------
       A. Âü∫Êú¨Â∏∏Êï∏
    ------------------------------------------------------- */
    const API_BASE = 'http://127.0.0.1:8000';      // FastAPI URL
    const userId   = ref(localStorage.getItem('healthAppUserId') || null);

    /* -------------------------------------------------------
       B. ÁãÄÊÖãÔºöË°®ÂñÆ / ÁµêÊûú
    ------------------------------------------------------- */
    const userForm = reactive({
      nickname:  null,
      height_cm: null,
      weight_kg: null,
      age:       null,
      gender:    'male',
      goal:      'maintain'
    });

    const dailyRecordForm = reactive({
      record_date: new Date().toISOString().slice(0, 10),   // YYYY-MM-DD
      calories_consumed:            null,
      protein_g:                    null,
      fat_g:                        null,
      carbs_g:                      null,
      calories_burned_exercise:     0
    });

    const dailySummary = reactive({
      bmr:                        null,
      recommended_daily_calories: null,
      calorie_balance:            null,
      llm_feedback:               null
    });

    /* -------------------------------------------------------
       C. UI ÁãÄÊÖã
    ------------------------------------------------------- */
    const users          = ref([]);
    const messageText      = ref('');
    const messageType      = ref('success');
    const isLoadingUser    = ref(false);
    const isLoadingRecord  = ref(false);
    const isLoadingSummary = ref(false);
    const selectedUserId = ref(null); 
    const showProfileForm = ref(true);

    /* -------------------------------------------------------
       D. üìÖ v-calendar
    ------------------------------------------------------- */
    const filledDates   = ref([]);   // ["2025-05-14", ...]
    const calendarAttrs = ref([]);   // v-calendar highlight Ë®≠ÂÆö

    async function loadFilledDates () {
      if (!userId.value) return;
      try {
        const r = await fetch(`${API_BASE}/users/${userId.value}/daily_records/dates/`);
        if (!r.ok) throw new Error(await r.text());
        filledDates.value = await r.json();

        calendarAttrs.value = [{
            key: 'done',
            dates: filledDates.value,          // ISO Â≠ó‰∏≤Èô£Âàó
            highlight: {
                fillMode: 'solid',
                class: 'has-record'
            }
        }];
      } catch (err) {
        console.error('loadFilledDates', err);
      }
    }

    function onDayClick ({ id }) {          // id = YYYY-MM-DD
      dailyRecordForm.record_date = id;

      if (filledDates.value.includes(id)) {
        fetchDailySummary(id);
        fetchDailyRecord(id);               // È†êÂ°´Áï∂Êó•Ë≥áÊñô
      } else {
        resetFormFor(id);
        Object.assign(dailySummary, { bmr:null, recommended_daily_calories:null,
                                      calorie_balance:null, llm_feedback:null });
      }
    }

    function resetFormFor (dateStr) {
      Object.assign(dailyRecordForm, {
        record_date:               dateStr,
        calories_consumed:         null,
        protein_g:                 null,
        fat_g:                     null,
        carbs_g:                   null,
        calories_burned_exercise:  0
      });
    }

    async function fetchDailyRecord (dateStr) {
        try {
            const r = await fetch(`${API_BASE}/users/${userId.value}/daily_records/${dateStr}`);
            if (!r.ok) {
                console.warn('ÂñÆÊó•Á¥ÄÈåÑ‰∏çÂ≠òÂú®');
                return;
            }
            Object.assign(dailyRecordForm, await r.json());
        } catch (e) { console.error('fetchDailyRecord', e); }
    }

    /* -------------------------------------------------------
       E. ÈÄöÁî®ÊèêÁ§∫
    ------------------------------------------------------- */
    function showMessage (msg, type='success', ms=3000) {
      messageText.value = msg;
      messageType.value = type;
      if (ms) setTimeout(() => (messageText.value=''), ms);
    }

    /* -------------------------------------------------------
       F. ‰ΩøÁî®ËÄÖ
    ------------------------------------------------------- */
    function toggleProfileForm () {
      showProfileForm.value = !showProfileForm.value;
    }

    async function loadUsers () {
        const r = await fetch(`${API_BASE}/users/`);
        if (r.ok) users.value = await r.json();
    }

    async function onUserSelect () {
        if (!selectedUserId.value) {
            // ÈÅ∏„ÄåÊñ∞Â¢û‰ΩøÁî®ËÄÖ„Äç‚Üí Ê∏ÖÁ©∫Ë°®ÂñÆ„ÄÅuserId ÁΩÆ null
            userId.value = null;
            Object.assign(userForm, { 
                height_cm:null, weight_kg:null, age:null, gender:'male', goal:'maintain' 
            });
            Object.assign(dailySummary, {
                bmr:null, recommended_daily_calories:null,
                calorie_balance:null, llm_feedback:null
            });
            calendarAttrs.value = [];
        } else {
            // ÈÅ∏ÁèæÊúâ ‚Üí userId Ë®≠ÂÆöÔºÜËºâÂÖ•Ë≥áÊñô
            userId.value = selectedUserId.value;
            await fetchUserData();
            await loadFilledDates();
        }
    }

    async function fetchUserData () {
      if (!userId.value) return;
      isLoadingUser.value = true;
      try {
        const r = await fetch(`${API_BASE}/users/${userId.value}/`);
        if (!r.ok) throw new Error(await r.text());
        Object.assign(userForm, await r.json());
        showMessage('‰ΩøÁî®ËÄÖË≥áÊñôÂ∑≤ËºâÂÖ•');
      } catch (e) {
        console.error(e);
        localStorage.removeItem('healthAppUserId');
        userId.value = null;
        showMessage(`ËºâÂÖ•Â§±Êïó: ${e.message}`, 'error');
      } finally {
        isLoadingUser.value = false;
      }
    }

    async function saveUserProfile () {
      isLoadingUser.value = true;
      const isUpdate = Boolean(userId.value);
      const url      = isUpdate
        ? `${API_BASE}/users/${userId.value}/`
        : `${API_BASE}/users/`;
      const method   = isUpdate ? 'PUT' : 'POST';

      try {
        const r = await fetch(url, {
          method,
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(userForm)
        });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();

        if (!isUpdate) {
            userId.value = data.id;
            localStorage.setItem('healthAppUserId', data.id);
            await loadUsers();
            selectedUserId.value = userId.value;
        }
        Object.assign(userForm, data);
        showMessage(isUpdate ? 'Êõ¥Êñ∞ÂÆåÊàê' : 'ÂÑ≤Â≠òÂÆåÊàê');
        await loadFilledDates();
      } catch (e) {
        console.error(e);
        showMessage(`ÂÑ≤Â≠òÂ§±Êïó: ${e.message}`, 'error');
      } finally {
        isLoadingUser.value = false;
      }
    }

    /* -------------------------------------------------------
       G. ÊØèÊó•Ë®òÈåÑ API
    ------------------------------------------------------- */
    async function submitDailyRecord () {
      if (!userId.value) { showMessage('Ë´ãÂÖàÂÑ≤Â≠òÂü∫Êú¨Ë≥áÊñô', 'error'); return; }

      //ÂêåÊó•ÈáçË¶ÜÊ™¢Êü•
      if (filledDates.value.includes(dailyRecordForm.record_date)) {
        if (!confirm(`Êó•Êúü ${dailyRecordForm.record_date} Â∑≤ÊúâÁ¥ÄÈåÑÔºåÁ¢∫ÂÆöË¶ÅË¶ÜÂØ´Ôºü`)) {
                return;        // ‰ΩøÁî®ËÄÖÂèñÊ∂à
        }
      }
      isLoadingRecord.value = true;
      try {
        const r = await fetch(`${API_BASE}/users/${userId.value}/daily_records/`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(dailyRecordForm)
        });
        if (!r.ok) throw new Error(await r.text());
        showMessage('Â∑≤Êèê‰∫§ÔºåÊ≠£Âú®ÂàÜÊûê...');
        await fetchDailySummary(dailyRecordForm.record_date);
        await loadFilledDates();
      } catch (e) {
        console.error(e);
        showMessage(`Êèê‰∫§Â§±Êïó: ${e.message}`, 'error');
      } finally {
        isLoadingRecord.value = false;
      }
    }

    async function fetchDailySummary (dateStr) {
      if (!userId.value) return;
      isLoadingSummary.value = true;
      try {
        const r = await fetch(`${API_BASE}/users/${userId.value}/daily_summary/${dateStr}/`);
        if (!r.ok) throw new Error(await r.text());
        Object.assign(dailySummary, await r.json());
      } catch (e) {
        console.error(e);
        showMessage(`ÂàÜÊûêÂ§±Êïó: ${e.message}`, 'error');
      } finally {
        isLoadingSummary.value = false;
      }
    }

    /* -------------------------------------------------------
       H. È¶ñÊ¨°ËºâÂÖ•
    ------------------------------------------------------- */
    onMounted(async () => {
        await loadUsers();
        if (userId.value) {
            selectedUserId.value = parseInt(userId.value);
            await fetchUserData();
            await loadFilledDates();
        }
    });

    /* -------------------------------------------------------
       I. Êö¥Èú≤Áµ¶Ê®°Êùø
    ------------------------------------------------------- */
    return {
      // Ë≥áÊñô
      userId, users, selectedUserId,
      userForm, dailyRecordForm, dailySummary,
      // UI
      messageText, messageType, showProfileForm,
      isLoadingUser, isLoadingRecord, isLoadingSummary,
      // Êó•ÊõÜ
      calendarAttrs, onDayClick,
      // ÊñπÊ≥ï
      onUserSelect, saveUserProfile, submitDailyRecord, toggleProfileForm
    };
  }
});

/* 2. ÂÆâË£ù v-calendar plugin */
const VCPlugin = window.VCalendar?.default || window.VCalendar;
app.use(VCPlugin, {});

/* 3. ÊéõËºâ */
app.mount('#app');
